<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Tarea corta 3 con D3.js</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/d3-fetch.v1.min.js"></script>
</head>
<body>
    <h1>Visualización de JSON con D3.js</h1>
    <p>Lectura de datos desde un archivo JSON.</p>

    <!-- SVG para visualizar datos -->
    <svg id="jsonDemo" width="400" height="400" style="border: 1px solid black;"></svg>

    <script>
    // Define la función para visualizar datos en el SVG
    function drawText(selector, data) {
        const svg = d3.select(selector);
        // Elimina cualquier texto existente
        svg.selectAll("text").remove();
        
        // Agrega texto para cada elemento del JSON
        svg.selectAll("text")
          .data(data) // Vincula los datos al SVG
          .enter() // Crea nuevos elementos de texto
          .append("text")
          .attr("x", 10) // Posición horizontal
          .attr("y", (d, i) => (i + 1) * 20) // Posición vertical (20px entre líneas)
          .text(d => d.id + ": " + d.value); // Muestra id y valor
    }

    // Carga el archivo JSON y muestra datos en el SVG
    d3.json("./test.json") // Reemplaza con la ruta correcta al archivo JSON
      .then(function(data) {
        console.log("Datos leídos:", data); // Para verificar datos en la consola

        drawText("#jsonDemo", data); // Muestra datos en el SVG
      })
      .catch(function(error) {
        console.error("Error al cargar el JSON:", error); // Captura errores al cargar JSON
      });
    </script>

    <h1>Visualización del mapa de Estados Unidos</h1>

    <!-- SVG para visualizar datos -->
    <svg id="bnaDemo" width="1200" height="800" style="border: 1px solid black;"></svg>

    <script>
        // Función para extraer segmentos del archivo BNA
        function parseBna(data) {
            const lines = data.split("\n"); // Divide el contenido por líneas
            const segments = [];
            let currentSegment = null;

            lines.forEach(line => {
                const trimmedLine = line.trim(); // Elimina espacios adicionales
                if (trimmedLine.length === 0) {
                    return; // Ignorar líneas vacías
                }

                const parts = trimmedLine.split(","); // Divide por coma
                if (parts.length === 3) {
                    if (currentSegment) {
                        segments.push(currentSegment); // Guarda el segmento anterior
                    }

                    currentSegment = {
                        id: parts[0], // ID del segmento
                        sequence: parseInt(parts[1], 10), // Secuencia del segmento
                        unknownValue: parseInt(parts[2], 10), // Valor desconocido
                        coordinates: [],
                    };
                } else if (parts.length === 2) {
                    const x = parseFloat(parts[0]);
                    const y = parseFloat(parts[1]);
                    if (isNaN(x) || isNaN(y)) {
                        console.warn("Coordenada inválida:", parts); // Ignorar coordenadas inválidas
                    } else if (currentSegment) {
                        currentSegment.coordinates.push({ x, y });
                    }
                }
            });

            if (currentSegment) {
                segments.push(currentSegment); // Guarda el último segmento
            }

            return segments; // Devuelve todos los segmentos
        }

        // Función para dibujar caminos con escalas
        function drawPaths(svg, segments) {
            // Definir escalas para ajustar las coordenadas al SVG
            const xScale = d3.scaleLinear()
                .domain([-125, -65]) // Ajusta el rango a las coordenadas esperadas
                .range([0, 1200]); // Ajusta al tamaño del SVG

            const yScale = d3.scaleLinear()
                .domain([25, 50]) // Ajusta el rango para el eje Y
                .range([800, 0]); // Invierte para dibujar de abajo hacia arriba

            segments.forEach(segment => {
                const path = d3.path(); // Crear objeto path para el dibujo
                const coordinates = segment.coordinates;

                if (coordinates.length > 0) {
                    // Ajustar las coordenadas con las escalas
                    const scaledCoords = coordinates.map(coord => ({
                        x: xScale(coord.x),
                        y: yScale(coord.y),
                    }));

                    // Iniciar el camino
                    path.moveTo(scaledCoords[0].x, scaledCoords[0].y);

                    // Dibujar líneas entre coordenadas
                    scaledCoords.forEach((coord, index) => {
                        if (index > 0) {
                            path.lineTo(coord.x, coord.y);
                        }
                    });

                    svg.append("path")
                        .attr("d", path.toString()) // Asigna el camino
                        .attr("stroke", "black") // Color del trazo
                        .attr("fill", "none") // Sin relleno (aqui agregar el nombre)
                        .attr("data-id", segment.id);
                }
            });
        }

        d3.text("./states_usa.bna") // Asegúrate de que esta ruta sea correcta
            .then(function(data) {
                const segments = parseBna(data); // Procesar el archivo BNA
                const svg = d3.select("#bnaDemo"); // Seleccionar el SVG
                drawPaths(svg, segments); // Dibuja segmentos usando escalas
            })
            .catch(function(error) {
                console.error("Error al cargar el archivo BNA:", error); // Captura errores
            });
    </script>
</body>
</html>